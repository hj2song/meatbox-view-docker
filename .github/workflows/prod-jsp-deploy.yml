name: Deploy Docker Image(PROD/JSP)

on:
  workflow_dispatch:
    inputs:
      runDeploy:
        type: string
        required: true
      IMAGE_TAG:
        type: string
        required: false
 
run-name: ${{ github.event.inputs.IMAGE_TAG || 'Latest Tag Deploy' }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:                # Job-level permissions configuration starts here
      contents: write           # 'write' access to repository contents

    steps:
    # ìœ íš¨í•œ ë°°í¬ì¸ì§€ í™•ì¸
    - name: Check runDeploy input
      run: |
        if [[ "${{ github.event.inputs.runDeploy }}" != "${{ secrets.APP }}" && "${{ github.event.inputs.runDeploy }}" != "true" ]]; then
          echo "Error: Invalid value for runDeploy."
          exit 1
        else
          echo "runDeploy input is valid."
        fi

    # ì´ë¯¸ì§€ íƒœê·¸ ê°’ ì„¤ì •: ê°’ì´ ì—†ìœ¼ë©´ ìµœì‹  íƒœê·¸ ìë™ ê°€ì ¸ì˜¤ê¸°
    - name: Set Docker Image Tag
      run: |
        if [ -z "${{ github.event.inputs.IMAGE_TAG }}" ]; then
          TAG=$(curl -s -H "Authorization: token ${{ secrets.ACCESS_TOKEN }}" \
          https://api.github.com/repos/${{ secrets.SOURCE_REPO }}/tags \
          | jq -r '[.[] | select(.name | test("^[0-9]{4}/w[0-9]{2}/master-[0-9]{8}_v[0-9]{2}$"))]
                     | sort_by(.name | capture("(?<year>[0-9]{4})/w(?<week>[0-9]{2})/master-(?<date>[0-9]{8})_v(?<version>[0-9]{2})") |
                                .year, .week, .date, .version | tonumber)
                     | reverse
                     | .[0].name')
          echo $TAG
          IMAGE_TAG=${TAG//\//_}  # ìŠ¬ë˜ì‹œë¥¼ ì–¸ë”ìŠ¤ì½”ì–´ë¡œ ëŒ€ì²´
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        else
          TAG=${{ github.event.inputs.IMAGE_TAG }}
          IMAGE_TAG=${TAG//\//_}  # ìŠ¬ë˜ì‹œë¥¼ ì–¸ë”ìŠ¤ì½”ì–´ë¡œ ëŒ€ì²´
          echo "IMAGE_TAG=$IMAGE_TAG" >> $GITHUB_ENV
        fi
        echo "Docker Image Tag: ${IMAGE_TAG}"

    # # Slack ë°°í¬ ì‹œì‘ ì•Œë¦¼
    # - name: Send Slack Notification (Start)
    #   run: |
    #     curl -X POST -H 'Content-type: application/json' \
    #     --data '{"channel": "#slack_alert_test", "username": "Meatbox Deploy Bot", "icon_emoji": ":meatbox:", "text": "ğŸš€ *Deploy Started* for meatbox-${{ secrets.APP }} Docker Image. Tag: `'"$IMAGE_TAG"'`"}' \
    #     ${{ secrets.SLACK_WEBHOOK_URL }}

    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        path: docker

    - name: Checkout other repository
      uses: actions/checkout@v3
      with:
        repository: ${{ secrets.SOURCE_REPO }}
        path: ${{ secrets.APP }}
        token: ${{ secrets.ACCESS_TOKEN }}
        ref: '${{ github.event.inputs.IMAGE_TAG }}'

    # Docker Buildì— í•„ìš”í•œ íŒŒì¼ì„ DEPLOY ê²½ë¡œë¡œ ì´ë™
    - name: move deploy file
      run: |
        cp -a ${{ secrets.VIEW_PATH }}/webapp/WEB-INF/views ${{ secrets.DOCKER_PATH }}/deploy/views
        mv ${{ secrets.DOCKER_PATH }}/deploy/.dockerignore-jsp ${{ secrets.DOCKER_PATH }}/deploy/.dockerignore


    # # Minify ìˆ˜í–‰
    # - name: ant build
    #   run: ant -f ${{ secrets.APP }}/build.xml dist

    # Nexus Login
    - name: Login to Nexus Docker Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ secrets.NEXUS_REGISTRY }}
        username: ${{ secrets.NEXUS_USERNAME }}
        password: ${{ secrets.NEXUS_PASSWORD }}

    # buildx ì„¤ì •
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    # ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    - name: Build and Push
      uses: docker/build-push-action@v6
      with:
        context: ${{ secrets.DOCKER_PATH }}/deploy
        file: ${{ secrets.DOCKER_PATH }}/deploy/Dockerfile-${{ secrets.APP }}  # ì‚¬ìš©í•  Dockerfile
        push: true
        tags: |
          ${{ secrets.NEXUS_REGISTRY }}/prod/meatbox/${{ secrets.APP }}:${{ env.IMAGE_TAG }}
          ${{ secrets.NEXUS_REGISTRY }}/prod/meatbox/${{ secrets.APP }}:latest
        cache-from: type=gha # gha ëŠ” Guthub Actions ìš© ìºì‹œë¥¼ ì˜ë¯¸
        cache-to: type=gha,mode=max

    # Image Deployment
    - name: Deploy Image
      run: |
        echo | openssl s_client -showcerts -servername portainer.meatbox.co.kr -connect portainer.meatbox.co.kr:443 2>/dev/null | openssl x509 -outform PEM > portainer-cert.pem
        curl -X POST https://portainer.meatbox.co.kr/api/webhooks/18335019-6184-4c35-9e68-64dab57f1c30 --cacert portainer-cert.pem

    # # Slack ë°°í¬ ì™„ë£Œ ì•Œë¦¼
    # - name: Send Slack Notification (Completed)
    #   if: success()  # ì„±ê³µí•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    #   run: |
    #     curl -X POST -H 'Content-type: application/json' \
    #     --data '{"channel": "#slack_alert_test", "username": "Meatbox Deploy Bot", "icon_emoji": ":meatbox:", "text": "âœ… *Deploy Completed* for meatbox-${{ secrets.APP }} Docker Image. Tag: `'"$IMAGE_TAG"'`"}' \
    #     ${{ secrets.SLACK_WEBHOOK_URL }}

    # # Slack ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
    # - name: Send Slack Notification (Failed)
    #   if: failure()  # ì‹¤íŒ¨í•œ ê²½ìš°ì—ë§Œ ì‹¤í–‰
    #   run: |
    #     curl -X POST -H 'Content-type: application/json' \
    #     --data '{"channel": "#slack_alert_test", "username": "Meatbox Deploy Bot", "icon_emoji": ":meatbox:", "text": "âŒ *Deploy Failed* for meatbox-${{ secrets.APP }} Docker Image."}' \
    #     ${{ secrets.SLACK_WEBHOOK_URL }}

# NEXUS_USERNAME=
# NEXUS_PASSWORD=
# NEXUS_REGISTRY=nexus.meatbox.co.kr:5001
# VIEW=view
# DOCKER_PATH=docker/view
# VIEW_PATH=view/src/main
# SLACK_WEBHOOK_URL=https://hooks.slack.com/services/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
# ACCESS_TOKEN=
# SOURCE_REPO=meatbox-git/meatbox-web
